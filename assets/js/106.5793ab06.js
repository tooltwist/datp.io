(window.webpackJsonp=window.webpackJsonp||[]).push([[106],{630:function(e,t,s){"use strict";s.r(t);var o=s(60),a=Object(o.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"step-3-docker-image"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#step-3-docker-image"}},[e._v("#")]),e._v(" Step 3 - Docker image")]),e._v(" "),s("p",[e._v("In this step we build a Docker image for your master server and push it to an AWS repository where it\ncan be deployed to your various environments.")]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("Note")]),e._v(" "),s("p",[s("strong",[e._v("This step only needs to be performed once")]),e._v(", for one environment, and the\nresulting ECR repository and Docker image can be used for other environments as well.\nBy using the same exact same image of your application from development,\ntesting and staging, through to production, you reduce the possibility of\nintroducing bugs or incompatible versions of dependancies.")])]),e._v(" "),s("h2",{attrs:{id:"_3-1-the-util-directory"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-the-util-directory"}},[e._v("#")]),e._v(" 3.1 - The util directory")]),e._v(" "),s("p",[e._v("The "),s("code",[e._v("util")]),e._v(" directory in the project folder provides scripts to build a Docker image for your DATP application.")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("Project Directory\n├─ DATP\n├─ MONDAT\n├─ etc\n└─ util\n  ├─ 1.build-on-docker\n  ├─ 2.push-to-ecr\n  ├─ 3.deploy-to-XXX\n  ├─ start-on-docker\n  ├─ Config\n  ├─ Dockerfile\n  └─ etc\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("p",[e._v("These scripts will require tweaking for your environment.")]),e._v(" "),s("p",[e._v("A prerequisite for running these scripts is that you have the "),s("strong",[e._v("AWS CLI")]),e._v(" installed.\nIn some scripts you will see "),s("code",[e._v("AWS_PROFILE")]),e._v(" specified. This must have a corresponding entry in your "),s("code",[e._v("~/.aws/credentials")]),e._v(" file. For more\ninformation see the AWS CLI documentation.")]),e._v(" "),s("p",[e._v("The numbered scripts can be run in order to perform a normal deployment, however if you are still setting things up\nyou might want to test a few things along the way... After running")]),e._v(" "),s("h2",{attrs:{id:"_3-2-docker-build"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-docker-build"}},[e._v("#")]),e._v(" 3.2 - Docker Build")]),e._v(" "),s("p",[e._v("This script runs a "),s("code",[e._v("docker build")]),e._v(" to create the image of your application, based on the Dockerfile also in the util directory.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("./1.build-on-docker\n")])])]),s("p",[e._v("To ensure consistency between the desktop development environment and the application deployed on AWS, this Dockerfile should be\nsimilar to "),s("code",[e._v("~/vscode/Dockerfile.ubuntu")]),e._v(" excluding however any entries in that file that just support Visual Studio Code.")]),e._v(" "),s("p",[e._v("Once the image is built sucessfully, you can use test the image on your local machine.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("./start-on-docker\n")])])]),s("p",[e._v("The docker options provided by the script should allow the container to connect to the same database that is running when you\nare using Visual Studio Code to develop the application. You will need to create a config file "),s("code",[e._v("util/Config/config-for-juice-yourName-DOCKER.json")]),e._v(",\nand copying the example config file in the same directory usually works fine.")]),e._v(" "),s("p",[e._v("Once the container is running, the "),s("code",[e._v("docker ps")]),e._v(" command will show you the ports you can use to attach to the application.")]),e._v(" "),s("h2",{attrs:{id:"_3-3-create-ecr-repository"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-create-ecr-repository"}},[e._v("#")]),e._v(" 3.3 - Create ECR Repository")]),e._v(" "),s("p",[e._v("Amazon ECR (Elastic Container Repository) is a repository for your Docker images.")]),e._v(" "),s("p",[e._v("There will be "),s("strong",[e._v("one")]),e._v(" ECR repository for each project, irrespective of how many environments you deploy it to. The name of the repository should generally be the name of the project's repository in Github with a hyphen to replace the slash. For example, for "),s("code",[e._v("tooltwist/acme")]),e._v(" you would create an ECR repository named "),s("code",[e._v("tooltwist-acme")]),e._v(".")]),e._v(" "),s("h4",{attrs:{id:"template"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#template"}},[e._v("#")]),e._v(" Template")]),e._v(" "),s("p",[s("code",[e._v("https://s3-ap-southeast-1.amazonaws.com/tooltwist.aws-explorer.templates.2020-09-02/21.project-ecr-image-repo.cf")])]),e._v(" "),s("p",[s("code",[e._v("2021-11-06/21.project-ecr-image-repo.cf")])]),e._v(" "),s("h4",{attrs:{id:"fields"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fields"}},[e._v("#")]),e._v(" Fields")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("Field")]),e._v(" "),s("th",[e._v("Description")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("Stack Name")]),e._v(" "),s("td",[e._v("ecr-repositoryname  (e.g. 'ecr-tooltwist-acme')")])]),e._v(" "),s("tr",[s("td",[e._v("Docker image repository")]),e._v(" "),s("td",[e._v("Repository name (e.g. tooltwist-acme)")])])])]),e._v(" "),s("p",[e._v("Once the repository is created, go to your "),s("a",{attrs:{href:"https://ap-southeast-1.console.aws.amazon.com/ecr/repositories?region=ap-southeast-1",target:"_blank",rel:"noopener noreferrer"}},[e._v("ECR Dashboard"),s("OutboundLink")],1),e._v(" and select the new repository to see the details of the repository.")]),e._v(" "),s("h2",{attrs:{id:"_3-4-push-to-ecr-repo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-push-to-ecr-repo"}},[e._v("#")]),e._v(" 3.4 - Push to ECR repo")]),e._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),s("p",[e._v("Before running this scripts check that constant values provided at the top, that define\nyour AWS account, repository name, etc, are correct.")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("./2.push-to-ecr\n")])])]),s("p",[e._v("This command chooses a version number based upon the current date and time, and pushes the image up to your AWS ECR repository. When it finishes it displays a message containing the version number.")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("...\n0a1c0b220d6e: Layer already exists\nde1bb73bcb8b: Layer already exists\n0279b13c6fc6: Layer already exists\n2021-11-11.1533: digest: sha256:349011842dc903b82c5acfbc7353dc35b08c60a8b25514a4aa76e1000f6ea748 size: 8255\nPush 2021-11-11.1533 complete.\n\nNew tag is 2021-11-11.1533\n\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])]),s("p",[e._v("Take note of that tag / version number - you will need it to deploy the correct image into your envionment(s).")]),e._v(" "),s("h2",{attrs:{id:"_3-5-deployment-script-used-later"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-deployment-script-used-later"}},[e._v("#")]),e._v(" 3.5 - Deployment script (used later)")]),e._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[e._v("NOTE")]),e._v(" "),s("p",[e._v("This script deploys the image you pushed to the ECR repository into an "),s("em",[s("strong",[e._v("existing")])]),e._v(" service.\nWe mention it here because we've discussed the other scripts, but you will not be able to run it\nuntil you've completed the next step (Step 4 - Master node).")]),e._v(" "),s("p",[e._v("However, feel free to use this command later!")])]),e._v(" "),s("p",[e._v("You will often have multiple versions of this script, so you can deploy to your dev, test, staging environments.\nYou normally will not have a script for production, as you don't want developers doing production deployments.")]),e._v(" "),s("p",[e._v("The first parameter of this command will be the version number displayed by the previous step.")]),e._v(" "),s("div",{staticClass:"custom-block danger"},[s("p",{staticClass:"custom-block-title"},[e._v("Super important !!!")]),e._v(" "),s("p",[e._v("Make sure you provide an existing, valid, version number. If you mistype this the server deployment will hang,\nand you'll have to either cancel the update from the AWS console, or wait about half an hour for it to time out.")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",[s("code",[e._v("./3.deploy-to-dev 2011-10-04.1254\n")])])]),s("p",[e._v("This command will give you two options for following the status of the deployment. The first is a command you\ncan run using the AWS CLI, while the second is a link to the AWS Console.")]),e._v(" "),s("p",[e._v("This deployment works by performing an update of the version parameter supplied to the Cloudformation script\nthat provisions the service (in step 4 ahead). If you have any problems or need to debug this deployment,\ntake a look at the following likely hotspots:")]),e._v(" "),s("ul",[s("li",[e._v("Cloudformation console")]),e._v(" "),s("li",[e._v("The ECS task deployment, specifically the log entries for stopped (failed) tasks.")]),e._v(" "),s("li",[e._v("The Target group for the task.")]),e._v(" "),s("li",[e._v("The application security group for the environment.")])]),e._v(" "),s("p",[e._v("For more information refer to the AWS documentation, and AWS expert, or Aunty Google.")])])}),[],!1,null,null,null);t.default=a.exports}}]);
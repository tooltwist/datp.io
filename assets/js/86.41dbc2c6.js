(window.webpackJsonp=window.webpackJsonp||[]).push([[86],{595:function(e,t,a){"use strict";a.r(t);var r=a(60),s=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"step-4-master-node"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#step-4-master-node"}},[e._v("#")]),e._v(" Step 4 - Master node")]),e._v(" "),a("p",[e._v("In this section we configure and start up the DATP master node inside your environment's ECS Cluster, where it will be resistant to server failures, will scale automatically,\nand is accessible from the Internet via a load balancer.")]),e._v(" "),a("p",[e._v("You can restrict access to just your API Gateway, APIC or other gateway later.")]),e._v(" "),a("p",[e._v("The DATP Software will be deployed from the ECR repository you created in the previous step, and run as a Docker container in the ECS cluser.")]),e._v(" "),a("p",[e._v("You can choose to build the Docker image and put it into ECR manually, or you can set up a Code Pipline to do this automatically.\nThe normal procedure is to either manually or automatically build the Docker image in your development environment,\nand then deploy the exact same Docker image from the same ECR repository through your various stages\nof testing through and into production.")]),e._v(" "),a("p",[e._v("In this section we set up the service, and in a later step we optionally set up the build pipeline.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/848697/79914553-173bb980-8458-11ea-840e-55607a00b808.png",alt:"docker-promoting-50"}})]),e._v(" "),a("p",[e._v("Run though the following steps. For each you will need to go to your "),a("a",{attrs:{href:"https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cloudformation"),a("OutboundLink")],1),e._v(" stacks page. Select "),a("code",[e._v("Create stack -> with new resources (standard)")]),e._v(". Copy in the URL of the template below and press "),a("em",[e._v("Next")]),e._v(" then enter the fields as discussed below.")]),e._v(" "),a("p",[e._v("After filling in the fields as described below, skip through the remaining pages. No additional input is required unless specifically mentioned.")]),e._v(" "),a("p",[e._v("In values for environment "),a("code",[e._v("EEEEEE")]),e._v(" and prefix "),a("code",[e._v("PPP")]),e._v(" "),a("em",[e._v("must")]),e._v(" be the same as when the environment was created.")]),e._v(" "),a("h2",{attrs:{id:"_4-1-load-balancer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-load-balancer"}},[e._v("#")]),e._v(" 4.1 - Load balancer")]),e._v(" "),a("h4",{attrs:{id:"what-this-creates"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-this-creates"}},[e._v("#")]),e._v(" What this creates")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("1x Cloudwatch log group\n1x Secrets Manager secret\n1x Application Load Balancer (ALB)\n1x Load Balancer Listener\n1x Listener Rule\n1x Target Group\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br")])]),a("h4",{attrs:{id:"template"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#template"}},[e._v("#")]),e._v(" Template")]),e._v(" "),a("p",[a("code",[e._v("https://s3-ap-southeast-1.amazonaws.com/tooltwist.aws-explorer.templates.2020-09-02/31.app-loadbalancer.cf")])]),e._v(" "),a("p",[a("code",[e._v("2021-11-06/31.app-loadbalancer.cf")])]),e._v(" "),a("p",[e._v("or to use Fargate...")]),e._v(" "),a("p",[a("code",[e._v("2021-11-06/31.app-loadbalancer-fargate.cf")])]),e._v(" "),a("h4",{attrs:{id:"fields"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fields"}},[e._v("#")]),e._v(" Fields")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Field")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("Stack Name")]),e._v(" "),a("td",[e._v("EEEEEE-AAAAA-loadbalancer  (e.g. 'dev-acme-loadbalancer')")])]),e._v(" "),a("tr",[a("td",[e._v("Application Name")]),e._v(" "),a("td",[e._v("AAAAA (e.g. acme)")])]),e._v(" "),a("tr",[a("td",[e._v("Cost Code")]),e._v(" "),a("td",[e._v("This can be used to identify resources for billing purposes")])]),e._v(" "),a("tr",[a("td",[e._v("Environment Name")]),e._v(" "),a("td",[e._v("EEEEEE")])]),e._v(" "),a("tr",[a("td",[e._v("Healthcheck path")]),e._v(" "),a("td",[e._v("(e.g. /api/healthcheck)")])]),e._v(" "),a("tr",[a("td",[e._v("Prefix")]),e._v(" "),a("td",[e._v("PPP- (e.g. 'v1-')")])])])]),e._v(" "),a("h2",{attrs:{id:"_4-2-ecs-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-ecs-service"}},[e._v("#")]),e._v(" 4.2 - ECS Service")]),e._v(" "),a("h4",{attrs:{id:"what-this-creates-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-this-creates-2"}},[e._v("#")]),e._v(" What this creates")]),e._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("1x ECS Service Role\n1x ECS Service\n1x ECS Task Definition\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br")])]),a("h4",{attrs:{id:"template-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#template-2"}},[e._v("#")]),e._v(" Template")]),e._v(" "),a("p",[a("code",[e._v("https://s3-ap-southeast-1.amazonaws.com/tooltwist.aws-explorer.templates.2020-09-02/32.app-ecs-service.cf")])]),e._v(" "),a("p",[a("code",[e._v("32.app-ecs-service.cf")])]),e._v(" "),a("p",[e._v("or for Fargate")]),e._v(" "),a("p",[a("code",[e._v("32.app-ecs-service-fargate.cf")])]),e._v(" "),a("h4",{attrs:{id:"fields-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fields-2"}},[e._v("#")]),e._v(" Fields")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Field")]),e._v(" "),a("th",[e._v("Description")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("Stack Name")]),e._v(" "),a("td",[e._v("EEEEEE-AAAAAA-service  (e.g. 'dev-acme-service')")])]),e._v(" "),a("tr",[a("td",[e._v("Prefix")]),e._v(" "),a("td",[e._v("PPP- (e.g. 'v1-')")])]),e._v(" "),a("tr",[a("td",[e._v("Environment Name")]),e._v(" "),a("td",[e._v("EEEEEE")])]),e._v(" "),a("tr",[a("td",[e._v("Application Name")]),e._v(" "),a("td",[e._v("AAAAAA (e.g. acme)")])]),e._v(" "),a("tr",[a("td",[e._v("DockerImageRepository")]),e._v(" "),a("td",[e._v("our ECR repo (e.g. tooltwist-acme)")])]),e._v(" "),a("tr",[a("td",[e._v("Version")]),e._v(" "),a("td",[e._v("Our initial seed version ('initial')")])]),e._v(" "),a("tr",[a("td",[e._v("Desired count")]),e._v(" "),a("td",[e._v("start with 1")])]),e._v(" "),a("tr",[a("td",[e._v("Memory")]),e._v(" "),a("td",[e._v("256 for NodeJS, more for Java")])]),e._v(" "),a("tr",[a("td",[e._v("Port")]),e._v(" "),a("td",[e._v("Ask the development team (usually 3000 or 4000)")])])])]),e._v(" "),a("p",[e._v("Select "),a("em",[e._v("I acknowledge that AWS CloudFormation might create IAM resources.")]),e._v(" on the final page and press "),a("em",[e._v("Create Stack")]),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"_4-3-provide-a-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-provide-a-configuration"}},[e._v("#")]),e._v(" 4.3 - Provide a Configuration")]),e._v(" "),a("p",[e._v("Your project will now be trying to start, but without a configuration it will be failing it's healthchecks and continually restarting. You will need to (a) give the DATP service a configuration, and\n(b) let the DATP service "),a("em",[e._v("access")]),e._v(" the configuration.")]),e._v(" "),a("p",[e._v("In the previous step where you created the load balancer an "),a("em",[e._v("AWS Secrets Manager")]),e._v(" secret was created,\nwhich you will be able to see on your "),a("a",{attrs:{href:"https://ap-southeast-1.console.aws.amazon.com/secretsmanager/home?region=ap-southeast-1#/listSecrets",target:"_blank",rel:"noopener noreferrer"}},[e._v("Secrets Manager console"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h4",{attrs:{id:"updating-the-service-role"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#updating-the-service-role"}},[e._v("#")]),e._v(" Updating the Service Role")]),e._v(" "),a("p",[e._v("The ECS service just created has a "),a("code",[e._v("JUICE_CONFIG")]),e._v(" environment variable referencing this secret, however\nthe service will not yet be able to access that secret, without a policy in place. For security reasons we do not enable this access in the Cloudformation scripts, and you will need you to explicitly enable access to\nthe secret. This is done by updating the role ECS uses to start the service's task:")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Find the latest failed (stopped) task in the ECS Console, and look at the Logs tab. You should see\nan error message that incudes the "),a("em",[a("strong",[e._v("assumed role")])]),e._v(", the "),a("em",[a("strong",[e._v("action")])]),e._v(" and the "),a("em",[a("strong",[e._v("resource")])]),e._v(" the role needs to grant.")])]),e._v(" "),a("li",[a("p",[e._v("Go to the "),a("a",{attrs:{href:"https://ap-southeast-1.console.aws.amazon.com/secretsmanager/home?region=ap-southeast-1#!/listSecrets",target:"_blank",rel:"noopener noreferrer"}},[e._v("Secrets Manager Console page"),a("OutboundLink")],1),e._v(" for the region, and look up the ARN for the secret mentioned in the error.")])]),e._v(" "),a("li",[a("p",[e._v("Next, go to your "),a("a",{attrs:{href:"https://console.aws.amazon.com/iam/home?#/roles",target:"_blank",rel:"noopener noreferrer"}},[e._v("IAM Role Console page"),a("OutboundLink")],1),e._v(" and search for the role\nmatching the ARN in the error. For example, role "),a("code",[e._v("myenv-myproject-ECSRole")]),e._v(".")])])]),e._v(" "),a("p",[e._v("Add the following inline policy, replacing the Resource ARN with that of the secret.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",[a("code",[e._v('{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Action": "secretsmanager:GetSecretValue",\n            "Resource": "arn:aws:secretsmanager:ap-southeast-1:1234567890:secret:j-myenv-myproject-Xxyzlj",\n        }\n    ]\n}\n')])])]),a("h4",{attrs:{id:"configuration-secrets"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuration-secrets"}},[e._v("#")]),e._v(" Configuration / Secrets")]),e._v(" "),a("p",[e._v("The task / service now has access to the secret, but the secret is currently empty.")]),e._v(" "),a("p",[e._v("Return to the Go to the "),a("a",{attrs:{href:"https://ap-southeast-1.console.aws.amazon.com/secretsmanager/home?region=ap-southeast-1#!/listSecrets",target:"_blank",rel:"noopener noreferrer"}},[e._v("Secrets Manager Console page"),a("OutboundLink")],1),e._v(" and enter your JSON configuration into the secret as text.")]),e._v(" "),a("p",[e._v("The file "),a("code",[e._v("/workspace/datp-config.json")]),e._v(" can be used as a template, but make sure you update the\nhost names and ports to match your AWS environment, and include any other variables\nyour application uses from the secret.")]),e._v(" "),a("p",[e._v("With this done, your service for the master node should start successfully.")]),e._v(" "),a("hr")])}),[],!1,null,null,null);t.default=s.exports}}]);